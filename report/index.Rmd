---
title: An investegation into the profitability of Chicago taxis
author: Olav Førland
output: 
  html_document:
    code_folding: hide
    font-family: Times
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Naming the file index.Rmd and calling rsconnect::deployApp() posted the app succesfully on shiny server. 
#It created folder named rsconnect which contains two folders: documents and shinyapps.io
```



```{r Olav: Include packages and workspace, include=FALSE, eval=TRUE}

library(tidyverse)
library(sf)
library(leaflet)
library(ggmap)
library(mapview)
library(rgdal)
library(RColorBrewer)
library(janitor)
library(lubridate)
library(boot)
library(ggplot2)
library(gganimate)
library(gifski)

load("./olav_used_files/data/chicago_maps_workspace.RData")
load("./olav_used_files/data/companies_time_workspace.RData")


```

```{r Prepare chicago map, include=FALSE, eval=TRUE}
#Register API key to google
register_google(key="AIzaSyBT6yzDKV_DGcFGK9E-cXu0zNUD4WTJOZA")
            
#Get location of chicago
chicago <- geocode("Chicago, IL")

#Make leaflet map with chicago center -> make sure the maps are calculated at runtime
chicago_leaflet <- leaflet() %>% 
  setView(lng=chicago$lon, lat=chicago$lat, zoom=10) %>%
  addProviderTiles(providers$CartoDB.Positron) 
```

```{r, Yiren: Include packages and workspace, include = FALSE}
pacman::p_load(tidyverse, pacman, ggmap, janitor, sf, mapview, leaflet, rgdal, RColorBrewer, ggplot2, data.table, readr, qqplotr, GGally, lubridate, raster, spData, spDataLarge, tmap, osmdata, gifski, jsonlite, zoo,gganimate,plotly)
```



### Abstract
**TODO** --Insert text--

### Context
Since Uber was introduced the taxi industry has been under a massive pressure, which has put many drivers and taxi companies in a tough economic position. In 2015 the Chicago taxi industry even claimed that Uber and Lyft had reduced their business [by 30-40% during that summer](https://chicagoist.com/2015/10/07/cab_drivers_plan_24_hour_strike.php). Due to such developments in the industry, there are many solid analysis of taxis. It is our impression that most of these focus on the big trends in the taxi industry, often by looking at time series of the steady decline in activity. [This article](https://toddwschneider.com/posts/chicago-taxi-data/) by Todd. W. Schneider gives an interesting comparison of such an development in Chicago and New York, in addition to indicating which areas seem most profitable. 
We want to build on this analysis by first looking at the big trends in the industry in Chicago, and how the different companies have responded to these. Subsequently we will look at more resent years when analyzing where (and when?) individual taxi drivers can earn the most. 


Through this report we will analyze taxi trips made in Chicago over the period 2013 - 2020. Our data is collected from Chicago Data Portal, and can be found [here](https://data.cityofchicago.org/Transportation/Taxi-Trips/wrvz-psew). In addition we use [this](--insert--) data set from Chicago Data Portal to draw each area in the maps, and [wiki and per_capita_income](yiren knows from where) for additional information about each area. 

The goal of this project is to give taxi companies and their drivers in Chicago a guide to which areas they should operate in to maximize their profit, at different times of the day.


This translates to two questions:

* What can we learn from how the the different companies have responded the development in the taxi industry over the time period?
* What can taxi drivers expect to earn in the each areas at different times of the day?


### Metadata
**TODO** Add size of each data set

**Taxi_Trips_2020.csv** 

* `trip_start_timestamp`: Character representation of when the trip started on the format **MM/DD/YYYY hh:mm:ss**. Rounded to the nearest 15 minutes
* `trip_end_timestamp`: Character representation of when the trip ended on the format **MM/DD/YYYY hh:mm:ss**. Rounded to the nearest 15 minutes
* `trip_seconds`: Numeric representation of the time of the trip in seconds
* `trip_miles`: Numeric representation of distance of the trip in miles
* `pickup_community_area`: Discrete integer uniquely defining in which Community Area the trip began
* `dropoff_community_area`: Discrete integer uniquely defining in which Community Area the trip ended
* `trip_total`: Numeric value indicating the total cost of the trip, in USD

**Chicago_Community_Areas.shp**

* `geometry`: MultiPolygon object. Essentially a list of coordinates representing the borders of each area
* `area_num_1`: Discrete integer uniquely defining each Community Area. Corresponds to `pickup_community_area` and `dropoff_community_area` in *Taxi_Trips_2020.csv*
`community_name`: Character variable representing the name of each Community Area

**wiki.csv**

* `no.`: Equivalent to `area_num_1`
* `population`: Numeric representation of the population of each zone
* `area`: Numeric representation of the area of each zone, in $km^{2}$
* `density`: Numeric representation of the density of each zone, in $km^{2}$

**Per_Capita_Income.csv**

* `community_area_number`: Equivalent to `area_num_1`
* `percent_of_housing_crowded`: Numeric representation of the percent of occupied housing units with more than one person per room
* `percent_households_below_poverty`: Numeric representation of the percent of households living below the federal poverty level
* `percent_aged_16_unemployed`: Numeric representation of the percent of people aged 16 years or older in the labor force that are unemployed
* `percent_aged_25_without_high_school_diploma`: Numeric representation of the percent of people aged 25 years or older without a high school diploma
* `percent_aged_under_18_or_over_64`: Numeric representation of the percent of the population under 18 or over 64 years of age
* `per_capita_income`: Numeric representation of income per capita 


### Approach

We start by exploring the data. This includes getting an overview of different time series, exploring trends and generally looking for differences between areas, companies and points in time.

We will combine *OpenStreetMap*, *ggplot2*, *leaflet* and *sf* libraries to construct interactive maps. These interactive maps are made available through the use of *Shiny.*. Such visualizations allow to have a dynamic and simple overview of how basic statistics are distributed over different variables such as areas and time, in addition to making comparisons really intuitive. The reader is encouraged to explore the plots on her/his own. 

??:
We will use multilinear regression to model our data. On the data where such a model isn't appropriate, we will quantify our uncertainty with the bootstrap method. Finally we will utilize principal component analysis to uncover the unexplained parts of our analysis.


# Yirens work



```{r, include = FALSE}
load("yiren/yiren_total_count.RData")
df_total_count <- df_total_count %>% mutate(count = as.numeric(count), date = ym) %>% dplyr::select(-ym)
```


```{r Data function1, echo=FALSE, warning=FALSE, include=FALSE}
data_selection <- function(df_total_count, zone){
  my_data <- df_total_count %>%
    filter(pickup_community_area == zone)
  
  trip_zone <- my_data %>%
    dplyr::select(date, trip_total, count) %>%
    group_by(date) %>%
    summarise(taxi_revenue = sum(trip_total), number_of_trips = sum(count), average_revenue = taxi_revenue/number_of_trips) # add avg


  return(trip_zone)
}

data_selection(df_total_count, 77)
```




```{r, include=FALSE}
plot_zone <- function(df_total_count, zone, choice){
  # parse zone
  zone_num <- strsplit(zone, ",")[[1]][1]
  
  #parse choice
  if (choice == "trip_total") {
    p <- ggplot(data = data_selection(df_total_count, zone_num),
              aes(x = date, y = taxi_revenue))
  } else if (choice == "count") {
    p <- ggplot(data = data_selection(df_total_count, zone_num),
              aes(x = date, y = number_of_trips))
  } else {
    p <- ggplot(data = data_selection(df_total_count, zone_num),
              aes(x = date, y = average_revenue))
  }
   p <- p + geom_line(size=0.4, color = "#0C7BDC") +
     geom_smooth(
              ) +
    labs(x = "Date")  +
    scale_y_continuous(n.breaks = 10,
                       expand = expansion(mult = c(.02, .02))) +
    theme(axis.text.x = element_text(angle = 45)) +
     ggtitle(zone)

  p <- ggplotly(p)
  return(p)
}

```



```{r, include = FALSE}
# Defining the UI
ui <- fluidPage(
  
  sidebarPanel(
    selectInput("choice", label = "Options: ",
              choices = c("trip_total", "count", "average"), selected = "trip_total"),
    
    selectInput("zone", label = "Select Zone: ",
              choices = c('1, Rogers Park', '2, West Ridge', '3, Uptown', '4, Lincoln Square', '5, North Center', '6, Lake View', '7, Lincoln Park', '8, Near North Side', '9, Edison Park', '10, Norwood Park', '11, Jefferson Park', '12, Forest Glen', '13, North Park', '14, Albany Park', '15, Portage Park', '16, Irving Park', '17, Dunning', '18, Montclare', '19, Belmont Cragin', '20, Hermosa', '21, Avondale', '22, Logan Square', '23, Humboldt Park', '24, West Town', '25, Austin', '26, West Garfield Park', '27, East Garfield Park', '28, Near West Side', '29, North Lawndale', '30, South Lawndale', '31, Lower West Side', '32, The Loop', '33, Near South Side', '34, Armour Square', '35, Douglas', '36, Oakland', '37, Fuller Park', '38, Grand Boulevard', '39, Kenwood', '40, Washington Park', '41, Hyde Park', '42, Woodlawn', '43, South Shore', '44, Chatham', '45, Avalon Park', '46, South Chicago', '47, Burnside', '48, Calumet Heights', '49, Roseland', '50, Pullman', '51, South Deering', '52, East Side', '53, West Pullman', '54, Riverdale', '55, Hegewisch', '56, Garfield Ridge', '57, Archer Heights', '58, Brighton Park', '59, McKinley Park', '60, Bridgeport', '61, New City', '62, West Elsdon', '63, Gage Park', '64, Clearing', '65, West Lawn', '66, Chicago Lawn', '67, West Englewood', '68, Englewood', '69, Greater Grand Crossing', '70, Ashburn', '71, Auburn Gresham', '72, Beverly', '73, Washington Heights', '74, Mount Greenwood', '75, Morgan Park', "76, O'Hare Airport", '77, Edgewater'), selected = "32, The Loop")
  ),
  
  # Main panel for displaying outputs
  mainPanel(
    plotlyOutput("plot")
  )
)
```


```{r}
# Defining the server
server = function(input, output) {
  output$plot <- renderPlotly(plot_zone(df_total_count, input$zone, input$choice))
}
```


## What is going on in the Chicago Taxi industry?

As mentioned above, there are many articles and analysis describing the decay of the taxi industry in general. To see how this coincided with the taxi industry in Chicago, we start by looking at how the earnings and activity has developed throughout the years. 

```{r, echo = FALSE, warning = FALSE, message = FALSE}
load("yiren/simple plots.RData")

sum_year <- sum_year %>% mutate(date = ym) %>% select(-ym)
count_year <- count_year %>% mutate(date = ym, count = trip_total) %>% select(-ym)

ggplotly(sum_year %>% ggplot(aes(x = date , y=trip_total)) + geom_line() + geom_smooth() + ggtitle("Total Revenue of Taxi Trips"))
ggplotly(count_year %>% ggplot(aes(x = date , y=count)) + geom_line() + geom_smooth() + ggtitle("Number of Taxi Trips"))



```


Is clear that there is a trend downwards for the taxi industry in Chicago. The data is plotted alongside a (?? -> what model is used) model, which shows a significant downward slope. The model therefore works as a good tool to model the data in years ~ 2013 - 2018, but is not descriptive of more recent years (maybe specify what reasent years means). It is very sensitive to outliers, which early 2020 proved to be. The state of Illinois recorded their first case of Covid 19 January 24th, and two months later the goevrnor declared lockdown (https://www.chicagomag.com/chicago-magazine/march-2021/67-days-to-lockdown/). As this greatly restricted people's movements, it is natural to assume that this caused the great fall in taxi activity early 2020. This dramatic fall causes the model to depict values below zero in 2021 and onwards, which doesn't make any sense. 

More interestingly, the taxi industry seems to peak in 2015. As mentioned earlier, the chiacago taxi industry actually claimed that Uber and Lyft had, only over the summer of 2015, reduced their market share by 30-40 %. To explore this relationship we initially wanted to gather data from Uber and Lyft in Chicago. However, we have not found any records specific for Chicago. We instead have gathered data depicting the revenue of the total RideSharing market, from the entire US (TODO: add link). Although not entirely accuracte for the Chicago market, we believe the overall trend in the US will indicate the trend in Chicago as well. 
(*Comment*: case is that two last plot depict uber and rest of ridehailing companies, where uber alone has a significant higher revenue than the others. Don't know what the measures are, so simpler if one is removed)



```{r, echo = FALSE, warning = FALSE, message = FALSE}
uber = read_csv("./yiren/data/stock_uber.csv")
uber$Date = as.Date(uber$Date, format = "%d/%m/%Y")
uber$company = "uber"
uber = uber %>% mutate(Open = as.numeric(substr(Open, 2, nchar(Open)))) %>% select(Date, Open, company)

# ggplotly(uber %>% ggplot(aes(x = Date, y = Open)) + geom_smooth() + ggtitle("Uber Stock"))

lyft = read_csv("./yiren/data/stock_lyft.csv")
lyft$Date = as.Date(lyft$Date, format = "%d/%m/%Y")
lyft$company = "lyft"
lyft = lyft %>% mutate(Open = as.numeric(substr(Open, 2, nchar(Open)))) %>% select(Date, Open, company)

uber_lyft = uber %>% full_join(lyft, by = c("Date","Open", "company"))

# ggplotly(lyft %>% ggplot(aes(x = Date, y = Open, group)) + geom_smooth() + ggtitle("Lyft Stock"))

ggplotly(uber_lyft %>% ggplot(aes(x = Date, y = Open, group = company, color = company)) + geom_smooth() +
  scale_color_viridis_d() +
  labs(x = "Date", y = "Open") +
  theme(legend.position = "top") +
  ggtitle("Stock of Two Major Ridehailing App Companies in US"))

# source: https://www.businessofapps.com/data/uber-statistics/
year = 2016:2020
booking = c(19, 45, 50, 65, 57)
uber_gloss_booking = data.frame(year, booking)

ggplotly(uber_gloss_booking %>% ggplot(aes(x = year, y = booking)) + 
           geom_line() + 
           ggtitle("Uber Gross Booking") + 
           ylab("Booking ($bn)"))
# 
# years = 2014:2020
# valuation = c(18, 51, 63, 48, 72, 82, 46)
# uber_valuation = data.frame(years, valuation)
# 
# ggplotly(uber_valuation %>% ggplot(aes(x = years, y = valuation)) + geom_line() + ggtitle("Uber Valuation") + ylab("Uber Valuation ($bn)"))


# Source: https://www.businessofapps.com/data/taxi-app-market/
years = 2015:2020
revenue = c(3.7, 7.2, 9.9, 12.3, 14.7, 5.1)
us_taxi = data.frame(years, revenue)

ggplotly(us_taxi %>% ggplot(aes(x = years, y = revenue)) + geom_line() + ggtitle("US Ridehailing Revenue") + ylab("Total Revenue ($bn)"))


```

US ridehailing revenue might be a good explanation of why the year 2015 gives the peak of normal taxi trips. Before 2015, there was no data, whereas we know that its revenue should be less than 3.7 million based on the development of ridehailings. Hence we would say the increasing prosperity of US ridehailing app industry might be the main factor for the shrinking number of taxi trips in Chicago since 2015.





We create a shiny app which allows you to dive into each zone and look at their changes.

```{r shinyApp1, echo=FALSE, warning=FALSE}
#Use this after introduction, so that the reader is "invited" to explore more on his own
shinyApp(ui = ui, server = server)
```

## How does this development translate to each zone?

We start by getting a feel of how the activity, i.e. numbers of trips, has been distributed over the areas in the time period. 


### Total Number of Taxi Trips Since 2013

```{r, echo = FALSE, warning = FALSE, message = FALSE}

load("yiren/yiren_total_count_polygon_leaflet.RData")

pal1 <- colorBin("Oranges",bins=4, domain =log10(zone_total_count$total_count), )

labels <- sprintf(
  "<em>%s</em> <strong>%s</strong><br/>%s trips",
  zone_total_count$pickup_community_area, zone_total_count$community_name, 
  prettyNum(zone_total_count$total_count, big.mark = ",")
) %>% lapply(htmltools::HTML)

#Make the map
chicago_leaflet %>%
  addPolygons(data=zone_total_count,
              fillColor=~pal1(log10(zone_total_count$total_count)),
              color="lightgrey",
              weight=2,
              fillOpacity=0.8,
              highlightOptions = highlightOptions(
                weight=3,
                opacity=2,
                color="Oranges",
                bringToFront=TRUE),
              label=labels,
              labelOptions=labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto")) %>%
  
  addLegend("bottomright",
            pal = pal1,
            values = log10(zone_total_count$total_count),
            title = "Total Number of Taxi Trips Since 2013",
            opacity = 0.8,
            labFormat = leaflet::labelFormat(
              transform = function(x) 10^(x)))

```


This depict a fairly similar picture to the one in our first project (maybe add link, or dont bother mentioning it). The majority of the trips are concentrated in few areas; the airport *O'Hare* and the central areas *Loop*, *Near West Side* and *Near North Side*. O'Hare can is located north west of the central areas on the map. A downside with this map is that it depicts a static picture throughout a period of 8 years. As we are interested in getting a feel of how the activity has changed as well, we have made the following animation:

(this animation does not make sense, maybe think about changing)
```{r, echo = FALSE}
#Comment: This animation doesn't make sense. Keyword: the yellow balls
knitr::include_graphics("yiren/trips_by_year.gif")
```



### Applying PCA to Explain the difference among zones

We would like to use PCA to reduce the dimensionality as well as acquire the classification power of our data. We perform log on our `count_taxi_trips` variance first since it has great variance compared to other variables and will dominate without logrithmic transformation.

```{r, echo = FALSE}
knitr::include_graphics("./yiren/1.png")
```

As shown above, when we have 3 principle components, most of the variation will be explained.

```{r, echo = FALSE}
knitr::include_graphics("./yiren/2.png")
```

When PC1 increases, population, density, log_count and per_capita_income gets higher.
When PC2 increases, per_capita_income gets higher, hardship_index gets lower.
To classify zones based on the result, we apply k-means clustering.

```{r, echo = FALSE}
knitr::include_graphics("./yiren/5.png")
```


<em>&#8544;: Red cluster. we have zones Near North Side, Lake View, Lincoln Park and West Town, where they have high per_capita_income, density, and population, which can be the main reason why it gives the highest log_count, the indicator of number of taxi trips. Geographically, they also can be found in the interactive map above that they are located adjacent to each other.<br>
&#8545;: Blue cluster. it has high per_capita_income and low population.<br>
&#8546;: Purple cluster. it is the opposite to the blue one, with high population and low per_capita_income. Both of them have reasonable good amount of taxi trips.<br>
&#8547;: Green cluster. they have low per_capita_income and low population, hence low number of taxi trips.</em>


This indicates that both per_capita_income and population contribute to the activity in each zone. The following animation shows how these variables have affected each other throughout the period. We have plotted (log) Population on the x - axis, Per capita income on the y axis and indicate the activity in each area by the size of each areas point. Finally we show the changes through time by transitioning over months. 




```{r, echo = FALSE, warning = FALSE, message = FALSE}
load("yiren/df_temp_cluster.RData")

cluster = zone_total_count %>% inner_join(df_temp, by = "pickup_community_area")

pal2 <- colorBin("Dark2",bins=c(1,2,3,4,5), domain =cluster$cluster)

labels <- sprintf(
  "%s <strong>%s</strong><br/>cluster %d",
  cluster$pickup_community_area, cluster$community_name, cluster$cluster
) %>% lapply(htmltools::HTML)

legend_label <- c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4")

#

#Make the map
chicago_leaflet %>%
  addPolygons(data=cluster,
              fillColor=~pal2(cluster),
              color="lightgrey",
              weight=2,
              fillOpacity=0.8,
              highlightOptions = highlightOptions(
                weight=3,
                opacity=2,
                color="Oranges",
                bringToFront=TRUE),
              label=labels,
              labelOptions=labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto")) %>%
  
  addLegend("bottomright",
            pal = pal2,
            values = cluster,
            title = "K-means Clustering",
            opacity = 0.8,
            # labFormat = leaflet::labelFormat(
            #   transform = function(x) (x)))
            labFormat = function(type, cuts, p) {
              paste0(legend_label)
            })
            
```
- Cluster 1. High Trip Num, high population and high income
- Cluster 2. Middle Trip Num, Low population and high income
- Cluster 3. Low Trip Num, low population and low income
- Cluster 4. Middle Trip Num, high population and low income



### Relationship Between Taxi Trips and Ridehailing Trips
Since the ridehailing trip data in Chicago starts from November 2018, we are only able to explore their relationship since then, which sets a restriction on our investigation. However, it will still be interesting to know the two variables change throughout the years and interact with each other.




### What are the affects on the company's?

In the light of the above, the Chicago Taxi industry is under great pressure. When the demand for standard taxis decreases one would think that the amounts of companies would decrease as well. Perhaps a few of the companies capture all the customers, will it be equally split among the remaining? We will start this investigation by looking at how the amount of active taxi companies has changed over the period. 

```{r Company count, echo=FALSE}

knitr::include_graphics("./number_of_companies.png")

```

As we can see the number of different active taxi companies peaked around 2015, which as seen earlier was the most profitable time for taxi companies in Chicago. After 2015 the amounts of companies have dropped continously until around 2018 when it started to flatten out. To indicate the relative size of each company we will portray the total revenue. The following animation shows how the companies market shares have changed throughout the time period.

```{r Market share, echo=FALSE}
knitr::include_graphics("company_revenue.gif")
```








### Total Revenue by Area

To visualize the and highlight the differences between each area we have used interactive maps provided by the leaflet library. We used [this](https://data.cityofchicago.org/Facilities-Geographic-Boundaries/Boundaries-Community-Areas-current-/cauq-8yn6) dataset provided by Chicago Data Portal to visualize the borders between community areas. We attribute a color to each area, which indicates the size of the difference relative to the other areas. Our goal was to get a clear understanding of how area and time of the day affects revenue in each area, and being able to communicate these findings as clearly as possible.

As a basis for this analysis we have plotted a map centered around Chicago. This was done by using the `Leaflet` library to extract a map over Chicago through Google’s map API. Thereafter we extracted `pickup_community_area`, `community_name` and `geometry` from the dataset of community borders.

We will first look into how total revenue is distributed among the areas. The relevant variables we will use are `pickup_community_area` and `trip_total.` To indicate the total revenue in each area, we summarized every `trip_total` in each area. We then colored the areas in shades of blue representing their respective revenues.
Since the revenue differences between areas often vary by several orders of magnitude, we made the bins logarithmic. We must then interpret the coloring as an indication of the order of magnitude of the revenue, not the exact revenue.


```{r Plot trip total map, echo=TRUE}
#Make the map

trip_total_map(chicago_leaflet, areas_trip_total, label_trip_total, revenue_pal)

```

From the map it is clear that a few areas generate a disproportionate amount of the revenue, with Loop, O'Hare and Near West Side being the most prominent. These areas have the darkest color on the map. O'Hare is the airport of Chicago, and is located north west of the more central areas Loop and Near West Side. 
One might perhaps expect these numbers change throughout the day. We can visualize this by considering the following map.

**TODO** ---Insert interactive time map---

Does this imply that every driver should strive to spend as much time as possible in these areas?

### Average Waiting Time by Area

Not necessarily. The total revenue depends on several factors which differ between areas. For each area there are e.g. differences in population, movement of people and number of active taxis. Although an area generates the most money overall, it doesn't necessarily imply that each taxi driver is better off in that area. Just think of the large queues of taxis which are normal to see at airports - not exactly time efficient! 

If we start by neglecting the variations of average trip time and revenue between areas, the average waiting time in each area will be a fairly good representation of how attractive the area is for each individual driver; as the drivers only earn money when having a passenger. We represent the average waiting time as the average time it takes from a taxi drops someone off in an area, until the same taxi picks someone else up in the same area. We only consider pick-ups and drop-offs which happen in the same area. This is because taxis which travel from one area to another in between drop-off and pick-up will inflate the average time. This could potentially lead to the central areas getting higher averages, as taxi drivers are inclined to travel back to the city center after a drop-off.

We extract `taxi_id`, `trip_start_timestamp`, `trip_end_timestamp`, `pickup_community_area` and `dropoff_community_area` from our data set. We note that the time stamps has been rounded to nearest 15 minute for privacy purposes. Therefore the result will not be 100% accurate, but it will give a good estimate of the true time to pickup. The results are shown below.  

```{r Plot waiting time map, include=TRUE, warning=FALSE, echo=TRUE}

avg_waiting_time_map(chicago_leaflet, areas_pickup_time, label_avg_pickup_time, waiting_time_labels, time_pal)

```

By considering average waiting time we get a fairly different picture. The revenue and activity plot previously pointed towards the airport O'Hare and the central areas around Loop as the most attractive - or at least as generating the most money. We can now see that the taxis in these areas are more prone to waiting time, with O’Hare averaging 95 minutes between trips. This is probably an indication of higher competition. 

However, none of these plots paint the whole picture on its own. Although the waiting time at O’Hare airport is large, a trip from the airport to the city center would generate much more revenue than a trip from Loop to West Town. To take this into account we will consider the factors we previously neglected; average trip total and average trip time. 

### Expected Hourly Revenue by Area

We now want to get a single number indicating the attractiveness of each area. That is, for each individual taxi driver, we want to provide an answer to the question: 
"If I drive into this area to find a customer now, how much can I expect to earn per hour".
We therefore want *expected hourly rate*. We first find a general expression for revenue per unit of time, before converting it to hours:

\begin{align} 
\textit{revenue per time} = \frac{\textit{revenue per trip}}{\textit{time per trip}}
\end{align}

Because the driver spends time waiting prior to each trip, we view *time per trip* as the sum of waiting time and trip time. We then obtain:

\begin{align}
\textit{revenue per time} = \frac{\textit{revenue per trip}}{\textit{waiting time per trip + driving time per trip}}
\end{align}

We then obtain the expected revenue per hour for each area by plugging in the average waiting time from earlier, followed by calculating average revenue per trip and driving time per trip for each area. To measure the accuracy of our estimator we used the library boot to generate 1000 random bootstrap samples from each area, and calculate the average hourly rate for each of them. Since the function boot.ci didn't work on the data set, we extracted a 95% confidence interval by sorting the sampled values in each area, and taking the 25th and 975th largest values(source for this method). The obtained result and code for bootstrapping can be viewed below.  


```{r Plot hourly salary, include=TRUE, warning=FALSE, echo=TRUE}

expected_hourly_rate_map(chicago_leaflet, areas_hourly_rate, label_avg_hourly_rate, hourly_pal, hourly_labels)

```
<em>&#8544;: 95% confidence interval is shown when hovering over an area<br>
&#8545;: The estimator is represented as the bootstrapped average of the 25th and 75th quantile</em>

##### Code used to generate confidence intervals by bootstrap method:
```{r Bootstrapping, include=TRUE, warning=FALSE, echo=TRUE, eval=FALSE}

#Dont't really need this here

bootstrap_hourly_rate <- dropoff_to_pickup %>%
  mutate(waiting_time = (trip_start_timestamp - trip_end_timestamp)/60,
         trip_time = trip_seconds/60) %>%
  filter(pickup_community_area == dropoff_community_area) %>%
  filter(waiting_time < 300) %>%##remove outliers which indicate end of workday
  ungroup() %>%
  select(pickup_community_area, waiting_time, trip_total, trip_time) %>%
  group_by(pickup_community_area) %>%
  arrange(pickup_community_area)


boot_hourly_rate <- function(data, indices) {
  d <- data[indices,] %>% #allows boot to extract sample
    group_by(pickup_community_area) %>%
    summarise(avg_trip_total = mean(trip_total), 
              avg_trip_seconds = mean(trip_time),
              waiting_time = mean(waiting_time)) %>%
    mutate(hourly_rate = 60*avg_trip_total / (waiting_time + avg_trip_seconds))
  
  d$hourly_rate
}

res <- boot(data=bootstrap_hourly_rate, statistic=boot_hourly_rate, R=100)

conf_int <- tibble(
  lower_bound = numeric(),
  upper_bound = numeric()
)

hourly_rate_boots <- as_tibble(res$t)

for (col in hourly_rate_boots) {
  len <- length(col)
  indices = as.integer(c(len*0.025 + 1, len*0.975 + 1))
  vals <- c(sort(col, partial=indices[1])[indices[1]],
            sort(col, partial=indices[2])[indices[2]])
  conf_int <- conf_int %>% add_row(lower_bound = vals[1], upper_bound = vals[2])
}

areas_hourly_rate <- areas %>%
  inner_join(avg_hourly_rate, by="pickup_community_area") %>%
  mutate(hourly_rate=as.integer(hourly_rate)) %>%
  print()

areas_hourly_rate <- areas_hourly_rate %>%
  arrange(pickup_community_area) %>%
  add_column(lower_bound = conf_int$lower_bound, upper_bound = conf_int$upper_bound) %>%
  mutate(hourly_rate = (lower_bound + upper_bound) / 2) 
```


The bootstrapped confidence intervals give us a good measure of the uncertainty in each area. By not only considering our estimator, but the uncertainty of our measurements as well, we obtain a more representative model of expected revenue. We observe for example that there are great differences between the sizes of the confidence intervals. The central areas around Loop have for example very tight confidence intervals, which is due to much activity, i.e. many samples. On the other hand, there also exist areas with huge confidence intervals.

The model also reveals interesting patterns. The areas with the highest expected hourly rate often has the largest confidence intervals. However, in the category below, i.e. 35 - 40 \$, you find many areas with expected hourly rate close to 40$, which also have tight confidence intervals. Even more interestingly these areas do not coincide with the areas with the most activity.

These findings indicate that it is not necessarily the most active areas which will earn the taxi drivers the most money. To assess the strength of this hypothesize we would need to test it on more data from different years. An idea for further development would be to calculate the expectations for each hour of the day as well. By combining more data with this segmentation, the model could have real practical value.




### References


* [](https://toddwschneider.com/posts/chicago-taxi-data/)
* [](https://chicagoist.com/2015/10/07/cab_drivers_plan_24_hour_strike.php)


```{r Try to include app, include=TRUE}

#knitr::include_app("https://uberlu.shinyapps.io/Dropoff/")

```




